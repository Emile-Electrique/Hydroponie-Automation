<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hydroponie Automation</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html, body { height: 100%; }

    body {
      margin: 0;
      background: linear-gradient(#4e8ffb 0%, #8fb6ff 45%, #ffffff 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      position: relative;
      overflow: hidden;
    }

    /* Views */
    .view { position: absolute; inset: 0; display: none; }
    .view.active { display: block; }

    model-viewer { width: 100%; height: 100%; display: block; background: transparent; }

    /* Toolbars (thinner) */
    :root{
      --w-main: 175px;  /* ~1/3 thinner vs 260 */
      --w-sub: 215px;   /* ~1/3 thinner vs 320 */
      --pad: 18px;
    }

    .left-toolbar {
      position: fixed; top: 0; left: 0;
      height: 100%; width: var(--w-main);
      background: rgba(255, 255, 255, 0.94);
      padding: 14px 10px;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.25);
      box-sizing: border-box;
      display: flex; flex-direction: column; gap: 10px;
      z-index: 20;
    }

    .left-toolbar h2 {
      margin: 0 0 2px 0;
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .tab-btn, .subtab-btn {
      width: 100%;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.85);
      padding: 9px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 650;
      text-align: left;
      font-size: 0.92rem;
    }
    .tab-btn:hover, .subtab-btn:hover { background: rgba(255,255,255,1); }
    .tab-btn.active, .subtab-btn.active {
      border-color: rgba(78,143,251,0.7);
      box-shadow: 0 0 0 3px rgba(78,143,251,0.18);
      background: rgba(255,255,255,1);
    }

    /* Subpanels */
    .subpanel {
      position: fixed; top: 0;
      height: 100%; width: var(--w-sub);
      background: rgba(255, 255, 255, 0.94);
      padding: 14px 10px;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.18);
      box-sizing: border-box;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 19;
    }
    .subpanel.active { display: flex; }

    #panel-l2 { left: var(--w-main); }
    #panel-l3 { left: calc(var(--w-main) + var(--w-sub)); z-index: 18; }

    .subpanel h3 {
      margin: 0;
      font-size: 0.92rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    /* Content padding so content doesn't hide behind toolbars */
    .content-pad {
      height: 100%;
      box-sizing: border-box;
      padding: var(--pad);
    }
    .pad-1 { padding-left: calc(var(--pad) + var(--w-main)); }
    .pad-2 { padding-left: calc(var(--pad) + var(--w-main) + var(--w-sub)); }
    .pad-3 { padding-left: calc(var(--pad) + var(--w-main) + var(--w-sub) + var(--w-sub)); }

    /* Cards */
    .card {
      width: min(980px, 96%);
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.10);
      backdrop-filter: blur(6px);
    }

    /* Materials */
    .materials-header {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }
    .materials-header h3 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .materials-header small { color: #555; }

    .materials-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    .materials-table th, .materials-table td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,0.10);
      text-align: right;
      white-space: nowrap;
    }
    .materials-table th:first-child, .materials-table td:first-child { text-align: left; }
    .materials-table thead th { font-weight: 800; }
    .materials-table tbody tr:last-child td { border-bottom: none; }

    /* Document surface */
    .doc-surface {
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    iframe.doc { width: 100%; height: 100%; border: 0; display: none; }
    iframe.doc.active { display: block; }

    img.doc-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      background: rgba(255,255,255,0.4);
    }
    img.doc-img.active { display: block; }

    /* Code viewer */
    .code-wrap {
      height: 100%;
      display: none;
      flex-direction: column;
    }
    .code-wrap.active { display: flex; }

    .code-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.85);
    }
    .code-toolbar .title {
      font-weight: 800;
      letter-spacing: 0.02em;
    }
    .code-toolbar button {
      border: 1px solid rgba(0,0,0,0.14);
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .code-toolbar button:hover { background: white; }

    pre.code {
      margin: 0;
      padding: 14px 14px 18px 14px;
      overflow: auto;
      height: 100%;
      box-sizing: border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.92rem;
      line-height: 1.35;
      background: rgba(10, 16, 28, 0.92);
      color: #e9eefc;
      white-space: pre;
    }

    .empty-center {
      height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
      box-sizing: border-box;
    }

    .banner {
      position: fixed;
      left: 18px;
      right: 18px;
      bottom: 18px;
      background: rgba(255,255,255,0.88);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      display: none;
      z-index: 50;
    }
    .banner.show { display: block; }

    /* Mobile */
    @media (max-width: 980px) {
      .pad-1, .pad-2, .pad-3 { padding-left: var(--pad); padding-top: 190px; }
      .left-toolbar { width: 100%; height: auto; }
      #panel-l2, #panel-l3 {
        left: 0; top: 100px;
        width: 100%; height: auto;
        max-height: 42%;
        overflow: auto;
      }
      #panel-l3 { top: 260px; }
    }
  </style>
</head>

<body>
  <!-- Views -->
  <section id="view-3d" class="view active">
    <model-viewer
      id="mv"
      src="./assets/models/assembly5.glb"
      camera-controls
      bounds="tight"
      camera-target="auto"
      camera-orbit="0deg 90deg 160%"
      field-of-view="24deg"
      min-field-of-view="18deg"
      max-field-of-view="50deg"
      environment-image="neutral"
      exposure="0.8"
      shadow-intensity="0.5"
      shadow-softness="0.9"
      touch-action="pan-y">
    </model-viewer>
  </section>

  <section id="view-mat" class="view">
    <div class="content-pad pad-1">
      <div class="card">
        <div class="materials-header">
          <h3>Matériaux</h3>
          <small>Profile 4040 (mm)</small>
        </div>

        <table class="materials-table">
          <thead>
            <tr>
              <th>Quantité</th>
              <th>Mesure</th>
              <th>Unité</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>4</td><td>2000</td><td>mm</td></tr>
            <tr><td>16</td><td>1280</td><td>mm</td></tr>
            <tr><td>2</td><td>1200</td><td>mm</td></tr>
            <tr><td>10</td><td>630</td><td>mm</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="view-equip" class="view">
    <div id="equipPad" class="content-pad pad-1">
      <div class="doc-surface">
        <!-- PDF / Image -->
        <iframe id="docFrame" class="doc" title="Document"></iframe>
        <img id="imgFrame" class="doc-img" alt="Wiring image" />

        <!-- Code viewer -->
        <div id="codeWrap" class="code-wrap">
          <div class="code-toolbar">
            <div class="title" id="codeTitle">Demo code</div>
            <button id="copyBtn" type="button">Copier</button>
          </div>
          <pre id="codeBlock" class="code"></pre>
        </div>

        <!-- Empty -->
        <div id="equipEmpty" class="empty-center">
          <div class="card" style="width:min(820px, 96%);">
            <h3 id="equipTitle" style="margin:0 0 8px 0;">Équipements</h3>
            <p id="equipText" style="margin:0;">
              Sélectionne un équipement (panneau 2), puis Wiring/Demo/Datasheet (panneau 3).
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-prog" class="view">
    <div class="content-pad pad-1">
      <div class="empty-center">
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Programme</h3>
          <p style="margin:0;">Écran vide pour l’instant.</p>
        </div>
      </div>
    </div>
  </section>

  <section id="view-guide" class="view">
    <div class="content-pad pad-1">
      <div class="empty-center">
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Guide d'installation</h3>
          <p style="margin:0;">Écran vide pour l’instant.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN toolbar -->
  <aside class="left-toolbar">
    <h2>Menu</h2>
    <button class="tab-btn active" data-tab="3d">Modèle 3D</button>
    <button class="tab-btn" data-tab="mat">Matériaux</button>
    <button class="tab-btn" data-tab="equip">Équipements</button>
    <button class="tab-btn" data-tab="prog">Programme</button>
    <button class="tab-btn" data-tab="guide">Guide d'installation</button>
  </aside>

  <!-- L2 -->
  <aside id="panel-l2" class="subpanel" aria-label="Équipements (niveau 2)">
    <h3>Équipements</h3>
    <button class="subtab-btn" data-equip="do">DO sensor</button>
    <button class="subtab-btn" data-equip="ph">pH sensor</button>
    <button class="subtab-btn" data-equip="ec">Conductivity sensor</button>
    <button class="subtab-btn" data-equip="pump">Peristatic pump</button>
  </aside>

  <!-- L3 -->
  <aside id="panel-l3" class="subpanel" aria-label="Détails (niveau 3)">
    <h3 id="l3Title">Détails</h3>
    <button class="subtab-btn" data-detail="wiring">Wiring</button>
    <button class="subtab-btn" data-detail="demo">Demo code</button>
    <button class="subtab-btn" data-detail="datasheet">Datasheet</button>
  </aside>

  <div id="banner" class="banner"></div>

  <script>
    // -------- paths for your DO sensor assets (in /docs/assets/Equipements/DO_Sensor/) --------
    // NOTE: spaces must be URL-encoded (%20)
    const DO_BASE = "./assets/Equipements/DO_Sensor/";
    const DO_WIRING_IMG = DO_BASE + "DO%20Sensor%20Atlas%20Scientific.PNG";
    const DO_DATASHEET_PDF = DO_BASE + "Surveyor-DO-datasheet.pdf";
    const DO_DEMO_INO = DO_BASE + "Sketch_Demo_DO_Sensor/Sketch_Demo_DO_Sensor.ino";

    // ---------- Helpers ----------
    const banner = document.getElementById("banner");
    function showBanner(html) {
      banner.innerHTML = html;
      banner.classList.add("show");
      clearTimeout(showBanner._t);
      showBanner._t = setTimeout(() => banner.classList.remove("show"), 6500);
    }

    async function loadCode(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error("Not found");
        return await res.text();
      } catch {
        return "// Could not load file:\n// " + path;
      }
    }

    // ---------- Tabs ----------
    const tabs = Array.from(document.querySelectorAll(".tab-btn"));
    const views = {
      "3d": document.getElementById("view-3d"),
      "mat": document.getElementById("view-mat"),
      "equip": document.getElementById("view-equip"),
      "prog": document.getElementById("view-prog"),
      "guide": document.getElementById("view-guide"),
    };

    const panelL2 = document.getElementById("panel-l2");
    const panelL3 = document.getElementById("panel-l3");
    const equipPad = document.getElementById("equipPad");

    function setTab(key) {
      tabs.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
      Object.entries(views).forEach(([k, el]) => el.classList.toggle("active", k === key));

      if (key === "equip") {
        panelL2.classList.add("active");
        // L3 appears after selecting an equipment; keep padding consistent
        equipPad.classList.remove("pad-1","pad-2","pad-3");
        const l2 = panelL2.classList.contains("active");
        const l3 = panelL3.classList.contains("active");
        equipPad.classList.add(l3 ? "pad-3" : (l2 ? "pad-2" : "pad-1"));
      } else {
        panelL2.classList.remove("active");
        panelL3.classList.remove("active");
        equipPad.classList.remove("pad-1","pad-2","pad-3");
        equipPad.classList.add("pad-1");
      }
    }

    tabs.forEach(btn => btn.addEventListener("click", () => setTab(btn.dataset.tab)));
    setTab("3d");

    // 3D error hint
    const mv = document.getElementById("mv");
    mv.addEventListener("error", () => {
      showBanner(`<strong>Modèle 3D non chargé.</strong> Vérifie: <code>docs/assets/models/assembly5.glb</code>`);
    });

    // ---------- Équipements content ----------
    const docFrame = document.getElementById("docFrame");
    const imgFrame = document.getElementById("imgFrame");
    const codeWrap = document.getElementById("codeWrap");
    const codeBlock = document.getElementById("codeBlock");
    const codeTitle = document.getElementById("codeTitle");
    const copyBtn = document.getElementById("copyBtn");

    const equipEmpty = document.getElementById("equipEmpty");
    const equipTitle = document.getElementById("equipTitle");
    const equipText = document.getElementById("equipText");
    const l3Title = document.getElementById("l3Title");

    let currentEquip = null; // do | ph | ec | pump

    function hideAllContent() {
      docFrame.classList.remove("active");
      imgFrame.classList.remove("active");
      codeWrap.classList.remove("active");
      equipEmpty.style.display = "grid";
      docFrame.removeAttribute("src");
      imgFrame.removeAttribute("src");
      codeBlock.textContent = "";
    }

    function showEmpty(title, text) {
      hideAllContent();
      equipTitle.textContent = title;
      equipText.textContent = text;
    }

    // Only DO is wired to real assets right now. Add others when you have files.
    const EQUIP_ASSETS = {
      do: {
        label: "DO sensor",
        wiringImg: DO_WIRING_IMG,
        datasheetPdf: DO_DATASHEET_PDF,
        demoFile: DO_DEMO_INO,
      },
      ph: { label: "pH sensor", wiringImg: "", datasheetPdf: "", demoFile: "" },
      ec: { label: "Conductivity sensor", wiringImg: "", datasheetPdf: "", demoFile: "" },
      pump: { label: "Peristatic pump", wiringImg: "", datasheetPdf: "", demoFile: "" },
    };

    function collapseL2L3() {
      panelL2.classList.remove("active");
      panelL3.classList.remove("active");
      equipPad.classList.remove("pad-1","pad-2","pad-3");
      equipPad.classList.add("pad-1"); // only main toolbar remains
    }

    async function openDetail(detailKey) {
      if (!currentEquip) {
        showEmpty("Équipements", "Sélectionne d’abord un équipement.");
        return;
      }

      const cfg = EQUIP_ASSETS[currentEquip];
      equipEmpty.style.display = "none";
      docFrame.classList.remove("active");
      imgFrame.classList.remove("active");
      codeWrap.classList.remove("active");

      if (detailKey === "datasheet") {
        if (cfg.datasheetPdf) {
          docFrame.src = cfg.datasheetPdf;
          docFrame.classList.add("active");
        } else {
          showEmpty(cfg.label + " — Datasheet", "Écran vide pour l’instant (ajoute le PDF dans docs/assets).");
        }
      } else if (detailKey === "wiring") {
        if (cfg.wiringImg) {
          imgFrame.src = cfg.wiringImg;
          imgFrame.classList.add("active");
        } else {
          showEmpty(cfg.label + " — Wiring", "Écran vide pour l’instant (ajoute l’image dans docs/assets).");
        }
      } else { // demo
        if (cfg.demoFile) {
          codeTitle.textContent = cfg.label + " — Demo code";
          codeWrap.classList.add("active");
          codeBlock.textContent = "// Loading...\n";
          const code = await loadCode(cfg.demoFile);
          codeBlock.textContent = code;
        } else {
          showEmpty(cfg.label + " — Demo code", "Aucun fichier .ino défini.");
        }
      }

      // Collapse both L2 and L3 after selecting a L3 element
      collapseL2L3();
    }

    // Copy button
    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(codeBlock.textContent);
        showBanner("<strong>Copié !</strong> Le code est dans ton presse-papiers.");
      } catch {
        showBanner("<strong>Copie bloquée.</strong> Clique dans le code, Ctrl+A puis Ctrl+C.");
      }
    });

    // ---------- L2: select equipment (shows L3 beside it) ----------
    const l2Btns = Array.from(document.querySelectorAll("[data-equip]"));
    l2Btns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentEquip = btn.dataset.equip;
        l2Btns.forEach(b => b.classList.toggle("active", b === btn));

        panelL2.classList.add("active");
        panelL3.classList.add("active");
        l3Title.textContent = EQUIP_ASSETS[currentEquip].label;

        equipPad.classList.remove("pad-1","pad-2","pad-3");
        equipPad.classList.add("pad-3");

        showEmpty(EQUIP_ASSETS[currentEquip].label, "Choisis Wiring / Demo code / Datasheet.");
      });
    });

    // ---------- L3: details (collapses L2+L3 on selection) ----------
    const l3Btns = Array.from(document.querySelectorAll("[data-detail]"));
    l3Btns.forEach(btn => {
      btn.addEventListener("click", () => {
        l3Btns.forEach(b => b.classList.toggle("active", b === btn));
        openDetail(btn.dataset.detail);
      });
    });

    // Load errors
    imgFrame.addEventListener("error", () => {
      showBanner(`<strong>Image non chargée.</strong> Vérifie le nom exact dans <code>docs/assets/Equipements/DO_Sensor/</code> (espaces/majuscules).`);
    });
    docFrame.addEventListener("error", () => {
      showBanner(`<strong>PDF non chargé.</strong> Vérifie que le fichier est dans <code>docs/assets/Equipements/DO_Sensor/</code> et que le chemin est bon.`);
    });

    // Default
    hideAllContent();
    showEmpty("Équipements", "Sélectionne un équipement (panneau 2), puis un détail (panneau 3).");
  </script>
</body>
</html>
