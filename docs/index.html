<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hydroponie Automation</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html, body { height: 100%; }

    body {
      margin: 0;
      background: linear-gradient(#4e8ffb 0%, #8fb6ff 45%, #ffffff 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      position: relative;
      overflow: hidden;
    }

    /* Views */
    .view { position: absolute; inset: 0; display: none; }
    .view.active { display: block; }

    model-viewer {
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
    }

    /* Toolbars (thinner ~ 1/3) */
    :root{
      --w-main: 175px;  /* was 260 */
      --w-sub: 215px;   /* was 320 */
      --pad: 18px;
    }

    .left-toolbar {
      position: fixed;
      top: 0; left: 0;
      height: 100%;
      width: var(--w-main);
      background: rgba(255, 255, 255, 0.94);
      padding: 14px 10px;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.25);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
    }

    .left-toolbar h2 {
      margin: 0 0 2px 0;
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .tab-btn, .subtab-btn {
      width: 100%;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.85);
      padding: 9px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 650;
      text-align: left;
      font-size: 0.92rem;
    }
    .tab-btn:hover, .subtab-btn:hover { background: rgba(255,255,255,1); }
    .tab-btn.active, .subtab-btn.active {
      border-color: rgba(78,143,251,0.7);
      box-shadow: 0 0 0 3px rgba(78,143,251,0.18);
      background: rgba(255,255,255,1);
    }

    /* Subpanels: L2 then L3 to its right */
    .subpanel {
      position: fixed;
      top: 0;
      height: 100%;
      width: var(--w-sub);

      background: rgba(255, 255, 255, 0.94);
      padding: 14px 10px;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.18);
      box-sizing: border-box;

      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 19;
    }
    .subpanel.active { display: flex; }

    #panel-l2 { left: var(--w-main); }
    #panel-l3 { left: calc(var(--w-main) + var(--w-sub)); z-index: 18; }

    .subpanel h3 {
      margin: 0;
      font-size: 0.92rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    /* Content padding so it doesn't hide behind toolbars */
    .content-pad {
      height: 100%;
      box-sizing: border-box;
      padding: var(--pad);
    }
    .pad-1 { padding-left: calc(var(--pad) + var(--w-main)); }
    .pad-2 { padding-left: calc(var(--pad) + var(--w-main) + var(--w-sub)); }
    .pad-3 { padding-left: calc(var(--pad) + var(--w-main) + var(--w-sub) + var(--w-sub)); }

    /* Cards */
    .card {
      width: min(980px, 96%);
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.10);
      backdrop-filter: blur(6px);
    }

    /* Materials */
    .materials-header {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }
    .materials-header h3 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .materials-header small { color: #555; }

    .materials-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    .materials-table th, .materials-table td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,0.10);
      text-align: right;
      white-space: nowrap;
    }
    .materials-table th:first-child,
    .materials-table td:first-child { text-align: left; }
    .materials-table thead th { font-weight: 800; }
    .materials-table tbody tr:last-child td { border-bottom: none; }

    /* Document surface */
    .doc-surface {
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    iframe.doc {
      width: 100%;
      height: 100%;
      border: 0;
      display: none;
    }
    iframe.doc.active { display: block; }

    img.doc-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      background: rgba(255,255,255,0.4);
    }
    img.doc-img.active { display: block; }

    .empty-center {
      height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
      box-sizing: border-box;
    }

    .banner {
      position: fixed;
      left: 18px;
      right: 18px;
      bottom: 18px;
      background: rgba(255,255,255,0.88);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      display: none;
      z-index: 50;
    }
    .banner.show { display: block; }

    /* Mobile: stack */
    @media (max-width: 980px) {
      .pad-1, .pad-2, .pad-3 { padding-left: var(--pad); padding-top: 190px; }
      .left-toolbar { width: 100%; height: auto; }
      #panel-l2, #panel-l3 {
        left: 0;
        top: 100px;
        width: 100%;
        height: auto;
        max-height: 42%;
        overflow: auto;
      }
      #panel-l3 { top: 260px; }
    }
  </style>
</head>

<body>
  <!-- Views -->
  <section id="view-3d" class="view active">
    <model-viewer
      id="mv"
      src="./assets/models/assembly5.glb"
      camera-controls
      bounds="tight"
      camera-target="auto"
      camera-orbit="0deg 90deg 160%"
      field-of-view="24deg"
      min-field-of-view="18deg"
      max-field-of-view="50deg"
      environment-image="neutral"
      exposure="0.8"
      shadow-intensity="0.5"
      shadow-softness="0.9"
      touch-action="pan-y">
    </model-viewer>
  </section>

  <section id="view-mat" class="view">
    <div class="content-pad pad-1">
      <div class="card">
        <div class="materials-header">
          <h3>Matériaux</h3>
          <small>Profile 4040 (mm)</small>
        </div>

        <table class="materials-table">
          <thead>
            <tr>
              <th>Quantité</th>
              <th>Mesure</th>
              <th>Unité</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>4</td><td>2000</td><td>mm</td></tr>
            <tr><td>16</td><td>1280</td><td>mm</td></tr>
            <tr><td>2</td><td>1200</td><td>mm</td></tr>
            <tr><td>10</td><td>630</td><td>mm</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="view-equip" class="view">
    <div id="equipPad" class="content-pad pad-1">
      <div class="doc-surface">
        <iframe id="docFrame" class="doc" title="Document"></iframe>
        <img id="imgFrame" class="doc-img" alt="Wiring image" />
        <div id="equipEmpty" class="empty-center">
          <div class="card" style="width:min(820px, 96%);">
            <h3 id="equipTitle" style="margin:0 0 8px 0;">Équipements</h3>
            <p id="equipText" style="margin:0;">Sélectionne un équipement (panneau 2), puis Wiring/Demo/Datasheet (panneau 3).</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-prog" class="view">
    <div class="content-pad pad-1">
      <div class="empty-center">
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Programme</h3>
          <p style="margin:0;">Écran vide pour l’instant.</p>
        </div>
      </div>
    </div>
  </section>

  <section id="view-guide" class="view">
    <div class="content-pad pad-1">
      <div class="empty-center">
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Guide d'installation</h3>
          <p style="margin:0;">Écran vide pour l’instant.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN toolbar -->
  <aside class="left-toolbar">
    <h2>Menu</h2>
    <button class="tab-btn active" data-tab="3d">Modèle 3D</button>
    <button class="tab-btn" data-tab="mat">Matériaux</button>
    <button class="tab-btn" data-tab="equip">Équipements</button>
    <button class="tab-btn" data-tab="prog">Programme</button>
    <button class="tab-btn" data-tab="guide">Guide d'installation</button>
  </aside>

  <!-- L2 toolbar: equipment list (stays visible while in Équipements) -->
  <aside id="panel-l2" class="subpanel" aria-label="Équipements (niveau 2)">
    <h3>Équipements</h3>
    <button class="subtab-btn" data-equip="do">DO sensor</button>
    <button class="subtab-btn" data-equip="ph">pH sensor</button>
    <button class="subtab-btn" data-equip="ec">Conductivity sensor</button>
    <button class="subtab-btn" data-equip="pump">Peristatic pump</button>
  </aside>

  <!-- L3 toolbar: item details (same for all sensors/pump) -->
  <aside id="panel-l3" class="subpanel" aria-label="Détails (niveau 3)">
    <h3 id="l3Title">Détails</h3>
    <button class="subtab-btn" data-detail="wiring">Wiring</button>
    <button class="subtab-btn" data-detail="demo">Demo code</button>
    <button class="subtab-btn" data-detail="datasheet">Datasheet</button>
  </aside>

  <div id="banner" class="banner"></div>

  <script>
    // ---------- Helpers ----------
    const banner = document.getElementById("banner");
    function showBanner(html) {
      banner.innerHTML = html;
      banner.classList.add("show");
      clearTimeout(showBanner._t);
      showBanner._t = setTimeout(() => banner.classList.remove("show"), 6500);
    }

    // ---------- Tabs ----------
    const tabs = Array.from(document.querySelectorAll(".tab-btn"));
    const views = {
      "3d": document.getElementById("view-3d"),
      "mat": document.getElementById("view-mat"),
      "equip": document.getElementById("view-equip"),
      "prog": document.getElementById("view-prog"),
      "guide": document.getElementById("view-guide"),
    };

    const panelL2 = document.getElementById("panel-l2");
    const panelL3 = document.getElementById("panel-l3");
    const equipPad = document.getElementById("equipPad");

    function setTab(key) {
      tabs.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
      Object.entries(views).forEach(([k, el]) => el.classList.toggle("active", k === key));

      if (key === "equip") {
        panelL2.classList.add("active");
        // L3 only appears after selecting an equipment
        // Keep padding at least for L2; if L3 active, padding becomes pad-3
        equipPad.classList.remove("pad-1","pad-2","pad-3");
        equipPad.classList.add(panelL3.classList.contains("active") ? "pad-3" : "pad-2");
      } else {
        panelL2.classList.remove("active");
        panelL3.classList.remove("active");
        // reset padding if leaving
        equipPad.classList.remove("pad-1","pad-2","pad-3");
        equipPad.classList.add("pad-1");
      }
    }

    tabs.forEach(btn => btn.addEventListener("click", () => setTab(btn.dataset.tab)));
    setTab("3d");

    // 3D error hint
    const mv = document.getElementById("mv");
    mv.addEventListener("error", () => {
      showBanner(`<strong>Modèle 3D non chargé.</strong> Vérifie: <code>docs/assets/models/assembly5.glb</code>`);
    });

    // ---------- Équipements content ----------
    const docFrame = document.getElementById("docFrame");
    const imgFrame = document.getElementById("imgFrame");
    const equipEmpty = document.getElementById("equipEmpty");
    const equipTitle = document.getElementById("equipTitle");
    const equipText = document.getElementById("equipText");
    const l3Title = document.getElementById("l3Title");

    let currentEquip = null; // "do" | "ph" | "ec" | "pump"

    function clearContent() {
      docFrame.classList.remove("active");
      imgFrame.classList.remove("active");
      equipEmpty.style.display = "grid";
      docFrame.removeAttribute("src");
      imgFrame.removeAttribute("src");
    }

    function showEmpty(title, text) {
      clearContent();
      equipTitle.textContent = title;
      equipText.textContent = text;
    }

    // Map per equipment -> where to load datasheet/wiring (only DO has both right now)
    const EQUIP_ASSETS = {
      do: {
        label: "DO sensor",
        wiringImg: "./assets/DO%20Sensor%20Atlas%20Scientific.PNG",
        datasheetPdf: "./assets/Surveyor-DO-datasheet.pdf",
      },
      ph: {
        label: "pH sensor",
        wiringImg: "",       // add later
        datasheetPdf: "",    // add later
      },
      ec: {
        label: "Conductivity sensor",
        wiringImg: "",       // add later
        datasheetPdf: "",    // add later
      },
      pump: {
        label: "Peristatic pump",
        wiringImg: "",       // add later
        datasheetPdf: "",    // add later
      },
    };

    function openDetail(detailKey) {
      if (!currentEquip) {
        showEmpty("Équipements", "Sélectionne d’abord un équipement.");
        return;
      }

      const cfg = EQUIP_ASSETS[currentEquip];
      equipEmpty.style.display = "none";
      docFrame.classList.remove("active");
      imgFrame.classList.remove("active");

      if (detailKey === "datasheet") {
        if (cfg.datasheetPdf) {
          docFrame.src = cfg.datasheetPdf;
          docFrame.classList.add("active");
        } else {
          showEmpty(cfg.label + " — Datasheet", "Écran vide pour l’instant (ajoute le PDF dans docs/assets et mets le chemin).");
        }
      } else if (detailKey === "wiring") {
        if (cfg.wiringImg) {
          imgFrame.src = cfg.wiringImg;
          imgFrame.classList.add("active");
        } else {
          showEmpty(cfg.label + " — Wiring", "Écran vide pour l’instant (ajoute l’image et mets le chemin).");
        }
      } else {
        showEmpty(cfg.label + " — Demo code", "Écran vide pour l’instant.");
      }
    }

    // ---------- L2: select equipment (shows L3 to the right, not replacing) ----------
    const l2Btns = Array.from(document.querySelectorAll("[data-equip]"));
    l2Btns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentEquip = btn.dataset.equip;

        // Visual active
        l2Btns.forEach(b => b.classList.toggle("active", b === btn));

        // Show L3 beside L2
        panelL3.classList.add("active");
        l3Title.textContent = EQUIP_ASSETS[currentEquip].label;

        // Update padding to allow 2 subpanels
        equipPad.classList.remove("pad-1","pad-2","pad-3");
        equipPad.classList.add("pad-3");

        showEmpty(EQUIP_ASSETS[currentEquip].label, "Choisis Wiring / Demo code / Datasheet.");
      });
    });

    // ---------- L3: details ----------
    const l3Btns = Array.from(document.querySelectorAll("[data-detail]"));
    l3Btns.forEach(btn => {
      btn.addEventListener("click", () => {
        l3Btns.forEach(b => b.classList.toggle("active", b === btn));
        openDetail(btn.dataset.detail);
      });
    });

    // Load errors
    imgFrame.addEventListener("error", () => {
      showBanner(`<strong>Image non chargée.</strong> Vérifie le nom exact dans <code>docs/assets/</code> (espaces/majuscules).`);
    });
    docFrame.addEventListener("error", () => {
      showBanner(`<strong>PDF non chargé.</strong> Vérifie que le fichier est dans <code>docs/assets/</code> et que le chemin est bon.`);
    });

    // Default
    clearContent();
    showEmpty("Équipements", "Sélectionne un équipement (panneau 2), puis un détail (panneau 3).");
  </script>
</body>
</html>
